# Конфигурация транспорта

## Основные опции

| Параметр                  | Тип                                    | По умолчанию         | Назначение                                                                               |
| ------------------------- | -------------------------------------- | -------------------- | ---------------------------------------------------------------------------------------- |
| `botToken`                | `string`                               | —                    | Токен Telegram-бота, обязательный параметр.                                              |
| `chatId`                  | `string \| number \| Array<...>`       | —                    | Идентификатор(-ы) получателей. Допускается объект `{ chatId, threadId }` для тем.        |
| `threadId`                | `number`                               | —                    | Тема по умолчанию для всех сообщений (для супергрупп).                                   |
| `parseMode`               | `'HTML' \| 'Markdown' \| 'MarkdownV2'` | `'HTML'`             | Режим форматирования сообщения в Telegram.                                               |
| `disableNotification`     | `boolean`                              | `false`              | Отключает push-уведомления для отправляемых сообщений.                                   |
| `disableWebPagePreview`   | `boolean`                              | `true`               | Прячет превью ссылок.                                                                    |
| `includeContext`          | `boolean`                              | `true`               | Вставляет блок Context.                                                                  |
| `contextKeys`             | `string \| string[]`                   | `['context', 'ctx']` | Поля записи, интерпретируемые как пользовательский контекст.                             |
| `includeExtras`           | `boolean`                              | `true`               | Добавляет секцию Extras с дополнительными полями лога.                                   |
| `extraKeys`               | `string[]`                             | —                    | Белый список полей для секции Extras. Если не задан — все поля, кроме зарезервированных. |
| `maxMessageLength`        | `number`                               | `4096`               | Максимальная длина текста (Telegram ограничивает сообщения).                             |
| `minDelayBetweenMessages` | `number`                               | `100`                | Минимальная пауза между сообщениями для одного чата (мс).                                |
| `retryAttempts`           | `number`                               | `3`                  | Количество попыток доставки, включая первую. Значение 1 отключает повторные посылки.     |
| `retryInitialDelay`       | `number`                               | `500`                | Стартовая пауза перед повторной попыткой (мс).                                           |
| `retryBackoffFactor`      | `number`                               | `2`                  | Множитель экспоненциального backoff для расчёта следующей паузы.                         |
| `retryMaxDelay`           | `number`                               | `10000`              | Верхняя граница паузы между повторами (мс).                                              |
| `formatMessage`           | `Function`                             | —                    | Пользовательский форматтер сообщения.                                                    |
| `onDeliveryError`         | `Function`                             | —                    | Обработчик ошибок доставки.                                                              |
| `send`                    | `Function`                             | —                    | Пользовательский способ отправки (для тестов/кастомных клиентов).                        |
| `headings`                | `Partial<FormatterHeadings>`           | —                    | Кастомные заголовки для форматтера по умолчанию.                                         |

## Повторы отправки

- Транспорт повторно отправляет сообщение при ответах Telegram Bot API `429` и `>=500`.
- Параметр `retry_after` из ответа используется как минимум для паузы перед следующей попыткой.
- При отсутствии `retry_after` применяется экспоненциальный backoff: `delay = delay * retryBackoffFactor` (с учётом `retryMaxDelay`).
- Количество попыток контролируется `retryAttempts`. После исчерпания вызов передаётся в `onDeliveryError` либо логируется в stderr.
- Для отключения повторов установите `retryAttempts = 1`.

## Поведение контекста и Extras

- Контекст берётся по первому совпадению ключа из `contextKeys`.
- Extras формируется из всех полей записи, кроме `level`, `time`, `msg`, `context`, `err`.
- Если `extraKeys` задан, берутся только перечисленные ключи (игнорируя зарезервированные).
- `includeExtras: false` полностью убирает секцию.

## Заголовки по умолчанию

```json
{
  "time": "Time",
  "context": "Context",
  "error": "Error",
  "extras": "Extras"
}
```

Задавайте произвольное подмножество:

```ts
headings: {
  time: 'Время',
  context: 'Контекст',
}
```

## Ограничение частоты и очередь

- `minDelayBetweenMessages` контролирует минимальный интервал между отправками в один чат.
- Транспорт использует внутреннюю очередь, чтобы не потерять порядок сообщений. Если `send` выбрасывает исключение, очередь продолжит обработку следующих записей.

## Частые сценарии

- **Несколько чатов и темы:** передайте массив `chatId`, в том числе с объектами `{ chatId, threadId }`.
- **Отключение Extras:** задайте `includeExtras: false` или перечислите допустимые поля в `extraKeys`.
- **Кастомное форматирование:** используйте `formatMessage`, чтобы полностью контролировать текст и дополнительные поля Telegram.
- **Принудительный resend:** добавьте `retryAttempts` и уменьшите `retryInitialDelay`, если критична скорость, но следите за лимитами Telegram.

## Переменные окружения

| Переменная           | Назначение                  |
| -------------------- | --------------------------- |
| `TELEGRAM_BOT_TOKEN` | Токен бота.                 |
| `TELEGRAM_CHAT_ID`   | Основной чат/пользователь.  |
| `TELEGRAM_GROUP_ID`  | Дополнительная супергруппа. |
| `TELEGRAM_THREAD_ID` | Тема в супергруппе.         |

> Подробная интеграция — в разделе [использования](usage.md).
