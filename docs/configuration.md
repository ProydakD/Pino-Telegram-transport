# Конфигурация транспорта

## Основные опции

| Параметр                  | Тип                                    | По умолчанию                                                             | Назначение                                                                               |
| ------------------------- | -------------------------------------- | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------- |
| `botToken`                | `string`                               | —                                                                        | Токен Telegram-бота, обязательный параметр.                                              |
| `chatId`                  | `string \| number \| Array<...>`       | —                                                                        | Идентификатор(-ы) получателей. Допускается объект `{ chatId, threadId }` для тем.        |
| `threadId`                | `number`                               | —                                                                        | Тема по умолчанию для всех сообщений (для супергрупп).                                   |
| `parseMode`               | `'HTML' \| 'Markdown' \| 'MarkdownV2'` | `'HTML'`                                                                 | Режим форматирования сообщения в Telegram.                                               |
| `disableNotification`     | `boolean`                              | `false`                                                                  | Отключает push-уведомления для отправляемых сообщений.                                   |
| `disableWebPagePreview`   | `boolean`                              | `true`                                                                   | Прячет превью ссылок.                                                                    |
| `includeContext`          | `boolean`                              | `true`                                                                   | Вставляет блок Context.                                                                  |
| `contextKeys`             | `string \| string[]`                   | `['context', 'ctx']`                                                     | Поля записи, интерпретируемые как пользовательский контекст.                             |
| `includeExtras`           | `boolean`                              | `true`                                                                   | Добавляет секцию Extras с дополнительными полями лога.                                   |
| `extraKeys`               | `string[]`                             | —                                                                        | Белый список полей для секции Extras. Если не задан — все поля, кроме зарезервированных. |
| `maxMessageLength`        | `number`                               | `4096`                                                                   | Максимальная длина текста (Telegram ограничивает сообщения).                             |
| `minDelayBetweenMessages` | `number`                               | `100`                                                                    | Минимальная пауза между сообщениями для одного чата (мс).                                |
| `formatMessage`           | `(input) => { text, extra }`           | —                                                                        | Кастомное форматирование. При использовании функций отключайте воркер.                   |
| `headings`                | `Partial<FormatterHeadings>`           | `{ time: 'Time', context: 'Context', error: 'Error', extras: 'Extras' }` | Кастомные заголовки для стандартного форматтера.                                         |
| `onDeliveryError`         | `(error, payload?) => void`            | —                                                                        | Колбэк при ошибке доставки.                                                              |
| `send`                    | `(payload) => Promise<void>`           | —                                                                        | Полная замена HTTP-запроса (например, для тестов или прокси).                            |

## Поведение контекста и Extras

- Контекст берётся по первому совпадению ключа из `contextKeys`.
- Extras формируется из всех полей записи, кроме `level`, `time`, `msg`, `context`, `err`.
- Если `extraKeys` задан, берутся только перечисленные ключи (игнорируя зарезервированные).
- `includeExtras: false` полностью убирает секцию.

## Заголовки по умолчанию

```json
{
  "time": "Time",
  "context": "Context",
  "error": "Error",
  "extras": "Extras"
}
```

Задавайте произвольное подмножество:

```ts
headings: {
  time: 'Время',
  context: 'Контекст',
}
```

## Ограничение частоты и очередь

- `minDelayBetweenMessages` контролирует минимальный интервал между отправками в один чат.
- Транспорт использует внутреннюю очередь, чтобы не потерять порядок сообщений. Если `send` выбрасывает исключение, очередь продолжит обработку следующих записей.

## Поддержка нескольких чатов

```ts
chatId: [
  process.env.TELEGRAM_CHAT_ID!,
  {
    chatId: Number(process.env.TELEGRAM_GROUP_ID),
    threadId: Number(process.env.TELEGRAM_THREAD_ID),
  },
];
```

Каждый получатель получит сообщение, а очередь гарантирует последовательность.

## Кастомные функции (formatMessage, send)

- При использовании воркера Pino (значение по умолчанию) функции нельзя клонировать → получите `DataCloneError`.
- Решения:
  - Отключить воркер: `pino({ transport: { target: 'pino-telegram-logger-transport', options, worker: { enabled: false } } })` (требует Node >= 18.12).
  - Использовать прямое создание транспорта: `const stream = telegramTransport(options); pino({}, stream);` — см. примеры.

## Переменные окружения

| Переменная           | Назначение                  |
| -------------------- | --------------------------- |
| `TELEGRAM_BOT_TOKEN` | Токен бота.                 |
| `TELEGRAM_CHAT_ID`   | Основной чат/пользователь.  |
| `TELEGRAM_GROUP_ID`  | Дополнительная супергруппа. |
| `TELEGRAM_THREAD_ID` | Тема в супергруппе.         |

> Подробная интеграция — в разделе [использования](usage.md).
