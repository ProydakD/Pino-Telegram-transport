# Конфигурация

Русская версия · [English version](configuration.en.md)

## Опции Транспорта

| Опция                     | Тип                                    | Значение по умолчанию                                                    | Описание                                                                                            |
| ------------------------- | -------------------------------------- | ------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------- |
| `botToken`                | `string`                               | —                                                                        | Укажите токен Telegram-бота. Обязательная опция.                                                    |
| `chatId`                  | `string \| number \| RawChatTarget[]`  | —                                                                        | Определяет один или несколько целевых чатов. Поддерживает массивы и объекты `{ chatId, threadId }`. |
| `threadId`                | `number`                               | —                                                                        | Общая тема для всех сообщений. Значение переопределяется `target.threadId`.                         |
| `parseMode`               | `'HTML' \| 'Markdown' \| 'MarkdownV2'` | `'HTML'`                                                                 | Управляет форматированием текста сообщения.                                                         |
| `disableNotification`     | `boolean`                              | `false`                                                                  | Делает сообщения тихими.                                                                            |
| `disableWebPagePreview`   | `boolean`                              | `true`                                                                   | Отключает предпросмотр ссылок для `sendMessage`.                                                    |
| `includeContext`          | `boolean`                              | `true`                                                                   | Включает блок `Context` с пользовательскими данными.                                                |
| `contextKeys`             | `string \| string[]`                   | `['context', 'ctx']`                                                     | Задаёт ключи, из которых берётся контекст.                                                          |
| `includeExtras`           | `boolean`                              | `true`                                                                   | Добавляет блок `Extras` с прочими полями лога.                                                      |
| `extraKeys`               | `string[]`                             | —                                                                        | Ограничивает поля, попадающие в `Extras`.                                                           |
| `maxMessageLength`        | `number`                               | `4096`                                                                   | Максимальная длина текста. Для медиа учитывайте лимит подписи 1024 символа.                         |
| `minDelayBetweenMessages` | `number`                               | `100`                                                                    | Минимальная пауза (мс) между сообщениями для одного чата.                                           |
| `retryAttempts`           | `number`                               | `3`                                                                      | Количество попыток доставки, включая первую.                                                        |
| `retryInitialDelay`       | `number`                               | `500`                                                                    | Стартовая задержка (мс) перед повтором.                                                             |
| `retryBackoffFactor`      | `number`                               | `2`                                                                      | Множитель экспоненциального увеличения задержки.                                                    |
| `retryMaxDelay`           | `number`                               | `10000`                                                                  | Максимальная задержка (мс) между попытками.                                                         |
| `formatMessage`           | `FormatMessageFn`                      | `createMediaFormatter()`                                                 | Пользовательский форматтер сообщений.                                                               |
| `onDeliveryError`         | `(error, payload?, method?) => void`   | —                                                                        | Обработчик ошибок доставки.                                                                         |
| `send`                    | `(payload, method) => Promise<void>`   | —                                                                        | Пользовательская функция отправки вместо HTTP-клиента.                                              |
| `headings`                | `Partial<FormatterHeadings>`           | `{ time: 'Time', context: 'Context', error: 'Error', extras: 'Extras' }` | Переопределяет заголовки блоков форматтера.                                                         |

## Форматтер по Умолчанию

- Собирает текст с эмодзи уровня (`🔍`, `🐛`, `ℹ️`, `⚠️`, `❗️`, `💀`) и заголовками.
- Ограничивает длину сообщения параметром `maxMessageLength`.
- Применяет `escapeHtml` для безопасной вставки HTML.

## Форматтер Медиа

`createMediaFormatter` анализирует лог и выбирает метод Bot API.

| Ключ в логе        | Назначение                                                                                     | Значение по умолчанию |
| ------------------ | ---------------------------------------------------------------------------------------------- | --------------------- |
| `messageType`      | Выбор метода (`text`, `photo`, `document`).                                                    | `messageType`         |
| `mediaUrl`         | Ссылка на файл.                                                                                | `mediaUrl`            |
| `mediaBuffer`      | Бинарные данные (`Buffer`, `Uint8Array`, `ArrayBuffer`, `{ type: 'Buffer', data: number[] }`). | `mediaBuffer`         |
| `mediaFilename`    | Имя файла при отправке документа.                                                              | `mediaFilename`       |
| `mediaContentType` | MIME-тип.                                                                                      | `mediaContentType`    |
| `caption`          | Подпись. Ограничивается `captionMaxLength` (по умолчанию 1024).                                | `caption`             |

Переопределяйте ключи через опции `createMediaFormatter({ typeKey, urlKey, bufferKey, ... })`.

## Поведение Клиента

- HTTP-клиент основан на `fetch` из `undici` и отправляет запросы `POST`.
- При ответах `429` и `5xx` включается повтор с экспоненциальным backoff.
- Значение `retry_after` из Telegram учитывается как минимальная задержка перед следующей попыткой.
- Пользовательская функция `send` получает `(payload, method)` и может реализовать любую логику доставки.

## Заголовки Сообщения

```ts
headings: {
  time: 'Время',
  context: 'Контекст',
  error: 'Ошибка',
  extras: 'Дополнительно',
}
```

Необязательные ключи можно опускать — транспорт подставит значения по умолчанию.

## Контекст и Extras

- Контекст сериализуется в блок `<pre>`.
- Секция Extras собирает пары `ключ: значение`, исключая зарезервированные поля (`level`, `time`, `msg`, `context`, `err`).
- Для крупных объектов учитывайте лимит `maxMessageLength`.

## Ограничения Telegram

- Подпись `sendPhoto` ограничена 1024 символами.
- Максимальный размер документа зависит от типа аккаунта бота (до 50 МБ).
- Для больших вложений используйте URL и храните файлы в объектном хранилище.
